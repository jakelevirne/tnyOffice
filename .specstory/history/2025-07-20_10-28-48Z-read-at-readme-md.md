<!-- Generated by SpecStory -->

# Real-time Markdown Editor: cr-SQLite Integration & API Updates (2025-07-20 10:28:48Z)

<!-- Claude Code Session 5d9e10a7-a8e4-437c-99fe-a159a3440a5f (2025-07-20_10-28-48Z) -->

_**User**_

read @README.md @apps/api/README.md and @apps/docs/README.md then create a new plan in @apps/docs/plans/ called automerge_plan.md that uses https://www.npmjs.com/package/@automerge/automerge-codemirror to communicate with the API we've built. you should read all the code files in https://github.com/automerge/automerge-codemirror/tree/main/src to understand clearly how automerge-codemirror works

---

_**Agent (claude-opus-4-20250514)**_

I'll read the automerge-codemirror source files to understand how it works, then create a plan for integrating it with your API.

_**Agent (claude-opus-4-20250514)**_

**Agent task list:**
- [ ] ðŸ”¥ Read automerge-codemirror source files to understand implementation
- [ ] ðŸ”¥ Create automerge_plan.md with integration design


_**Agent (claude-opus-4-20250514)**_

**Agent task list:**
- [âš¡] ðŸ”¥ Read automerge-codemirror source files to understand implementation
- [ ] ðŸ”¥ Create automerge_plan.md with integration design


_**Agent (claude-opus-4-20250514)**_

Tool use: **WebFetch**

Result:

```
Key Components of the Automerge Sync Plugin for CodeMirror 6:

1. Main Exported Functions:
- `automergeSyncPlugin`: Creates a ViewPlugin that synchronizes CodeMirror and Automerge documents
- `isReconcileTx`: Checks if a transaction is a reconciliation transaction

2. Document Change Handling:
- Tracks changes bidirectionally between CodeMirror and Automerge
- Uses `isProcessingCmTransaction` flag to prevent recursive change processing
- Applies CodeMirror transactions to Automerge document using `applyCmTransactionsToAmHandle()`
- Applies Automerge patches to CodeMirror using `applyAmPatchesToCm()`

3. Automerge Document Synchronization:
- Maintains "reconciled heads" to track document state
- Compares current document heads with previous state
- Generates and applies patches when document states diverge

4. Configuration Options:
- Requires a `DocHandle` from Automerge
- Needs a `path` array to specify document location
- Throws an error if document handle is not ready

The plugin ensures real-time, bidirectional synchronization between CodeMirror and Automerge documents with minimal overhead.
```

_**Agent (claude-opus-4-20250514)**_

Tool use: **WebFetch**

Error:

```
Request failed with status code 404
```

_**Agent (claude-opus-4-20250514)**_

Tool use: **WebFetch**

Result:

```
Based on the provided code snippet, the automerge-codemirror library exports:

1. `automergeSyncPlugin`: A plugin (likely for synchronization)
2. `DocHandle` type: A TypeScript type definition related to document handling

The exports suggest this is a library for collaborative editing or synchronization, with TypeScript type support.
```

_**Agent (claude-opus-4-20250514)**_

Tool use: **WebFetch**

Result:

```
Based on the web page content, the src directory of the automerge-codemirror library contains the following source files:

1. DocHandle.ts
2. amToCodemirror.ts
3. codeMirrorToAm.ts
4. index.ts
5. plugin.ts

These TypeScript files appear to be the core implementation files for the library, likely handling document synchronization and integration between Automerge and CodeMirror.
```

_**Agent (claude-opus-4-20250514)**_

Tool use: **WebFetch**

Result:

```
The code converts Automerge patches to CodeMirror transactions through these key mechanisms:

1. Main conversion function `applyAmPatchesToCm()`:
- Takes Automerge patches, target path, and CodeMirror view
- Iterates through patches
- Creates CodeMirror `ChangeSet` for each patch
- Dispatches transactions with reconciliation annotations

2. Patch handling functions for different patch types:
- `handleInsert()`: Inserts text at specific index
- `handleSplice()`: Splices text into document
- `handleDel()`: Deletes characters
- `handlePut()`: Replaces entire document content

3. Key utility function `charPath()`:
- Converts Automerge patch paths to character indices
- Validates path structure to ensure correct mapping

The conversion process transforms Automerge's patch-based change model into CodeMirror's transaction-based editing system, allowing seamless synchronization between the two editing frameworks.
```

_**Agent (claude-opus-4-20250514)**_

Tool use: **WebFetch**

Result:

```
Key points on converting CodeMirror transactions to Automerge changes:

1. Transaction Filtering:
- Filters out reconciliation transactions and empty changes
- Uses `transactions.filter()` to select meaningful text modifications

2. Change Application:
- Applies changes via `handle.change()` method
- Iterates through transactions using `tr.changes.iterChanges()`

3. Text Modification Mechanism:
- Uses Automerge's `A.splice()` to modify document
- Converts CodeMirror's `Text` object to string
- Tracks changes by source and destination positions (fromA, toA, fromB)

4. Path Handling:
- Clones the path to prevent modification during splice operation
- Supports nested document modifications through path array

The core transformation occurs by translating CodeMirror's granular text changes into Automerge's splice operations, enabling collaborative text editing across different document representations.
```

_**Agent (claude-opus-4-20250514)**_

Tool use: **WebFetch**

Result:

```
The DocHandle interface represents a handle for managing a document in the Automerge library, providing methods to:

- Check if the document is ready (`isReady()`)
- Access the current document state (`doc()`)
- Make changes to the document (`change()`)
- Listen for and remove change event callbacks (`on()` and `off()`)

It's a generic interface that allows type-safe interactions with Automerge documents, enabling reactive document manipulation and synchronization.

The interface suggests a reactive, event-driven approach to document management, where changes can be tracked and applied dynamically.
```

_**Agent (claude-opus-4-20250514)**_

**Agent task list:**
- [X] ðŸ”¥ Read automerge-codemirror source files to understand implementation
- [âš¡] ðŸ”¥ Create automerge_plan.md with integration design


_**Agent (claude-opus-4-20250514)**_

Tool use: **Write**

```md
# Automerge Integration Plan for TnyOffice Docs

## Overview

This plan outlines the integration of `@automerge/automerge-codemirror` to enable real-time collaborative editing in the TnyOffice Docs application. The integration will allow multiple users to edit markdown documents simultaneously with automatic conflict resolution using Automerge's CRDT (Conflict-free Replicated Data Type) technology.

## Architecture Overview

### Current State
- **Frontend**: Next.js app with CodeMirror 6 for markdown editing
- **Backend**: Express API with SQLite storage
- **Editor**: CodeMirror 6 with markdown syntax highlighting
- **Storage**: Documents stored in SQLite with id, filename, content, timestamps

### Target State
- **Frontend**: Same stack + Automerge for real-time sync
- **Backend**: API extended with WebSocket support for real-time updates
- **Editor**: CodeMirror 6 + automerge-codemirror plugin
- **Storage**: SQLite + Automerge document history/binary format

## Implementation Plan

### Phase 1: Backend Infrastructure

#### 1.1 Add Automerge to API Service
\```bash
cd apps/api
npm install @automerge/automerge @automerge/automerge-repo
npm install ws @types/ws  # WebSocket support
\```

#### 1.2 Create Automerge Document Model
- Extend SQLite schema to store Automerge binary documents
- Add columns: `automerge_binary` (BLOB), `automerge_heads` (TEXT)
- Create conversion utilities between markdown and Automerge documents

#### 1.3 WebSocket Server Implementation
- Add WebSocket server alongside Express
- Create sync protocol for document updates
- Handle client connections and document subscriptions

### Phase 2: Frontend Integration

#### 2.1 Install Dependencies
\```bash
cd apps/docs
npm install @automerge/automerge @automerge/automerge-codemirror
npm install @automerge/automerge-repo-network-websocket
\```

#### 2.2 Create Automerge Repository
- Initialize Automerge Repo in the frontend
- Configure WebSocket network adapter
- Create document handles for each opened document

#### 2.3 Integrate automerge-codemirror Plugin
- Modify `Editor.tsx` to use `automergeSyncPlugin`
- Create `DocHandle` for each document
- Configure bidirectional sync between CodeMirror and Automerge

### Phase 3: Synchronization Protocol

#### 3.1 Document Loading Flow
1. Client requests document by ID
2. API returns document metadata + Automerge binary
3. Client initializes Automerge document from binary
4. Client creates CodeMirror instance with sync plugin
5. WebSocket connection established for real-time updates

#### 3.2 Real-time Sync Flow
1. User makes edit in CodeMirror
2. `automergeSyncPlugin` converts CM transaction to Automerge change
3. Change synced to server via WebSocket
4. Server broadcasts change to other connected clients
5. Remote changes applied to local Automerge doc
6. Plugin updates CodeMirror with remote changes

#### 3.3 Persistence Flow
1. Server periodically saves Automerge binary to SQLite
2. On disconnect, client's final state is persisted
3. Conflict resolution handled automatically by Automerge

## API Changes

### New Endpoints

#### WebSocket Endpoint
\```
ws://localhost:3001/sync
\```

#### Modified REST Endpoints

##### GET /api/v1/files/:id
Response includes:
\```json
{
  "id": "uuid",
  "filename": "document.md",
  "content": "# Markdown content",
  "automerge_binary": "base64_encoded_binary",
  "created_at": 1234567890,
  "updated_at": 1234567890
}
\```

##### PUT /api/v1/files/:id
Accepts either:
- Traditional JSON with content field
- Automerge binary data for sync

### WebSocket Messages

#### Client â†’ Server
\```typescript
interface ClientMessage {
  type: 'subscribe' | 'unsubscribe' | 'sync';
  documentId: string;
  data?: Uint8Array; // Automerge sync data
}
\```

#### Server â†’ Client
\```typescript
interface ServerMessage {
  type: 'sync' | 'error' | 'subscribed';
  documentId: string;
  data?: Uint8Array; // Automerge sync data
  error?: string;
}
\```

## Component Changes

### Editor.tsx Modifications
\```typescript
import { automergeSyncPlugin } from '@automerge/automerge-codemirror';
import { DocHandle } from '@automerge/automerge-codemirror';

// In editor setup:
const docHandle = getDocumentHandle(documentId);
const syncPlugin = automergeSyncPlugin({
  handle: docHandle,
  path: ['content'] // Path to text content in Automerge doc
});

// Add to extensions:
extensions: [
  markdown(),
  syncPlugin,
  // ... other extensions
]
\```

### DocumentViewer.tsx Changes
- Add connection status indicator
- Show active collaborators
- Handle offline mode gracefully

## Database Schema Updates

\```sql
-- Add Automerge columns to files table
ALTER TABLE files ADD COLUMN automerge_binary BLOB;
ALTER TABLE files ADD COLUMN automerge_heads TEXT;

-- Create sync metadata table
CREATE TABLE sync_metadata (
  document_id TEXT PRIMARY KEY,
  last_sync INTEGER DEFAULT (unixepoch()),
  sync_version INTEGER DEFAULT 1,
  FOREIGN KEY (document_id) REFERENCES files(id)
);
\```

## Testing Strategy

### Unit Tests
- Test Automerge document conversions
- Test WebSocket message handling
- Test sync protocol edge cases

### Integration Tests
- Test multi-client editing scenarios
- Test conflict resolution
- Test offline/online transitions
- Test large document handling

### Manual Testing Scenarios
1. Two users editing same document
2. User goes offline, makes changes, comes back online
3. Multiple rapid edits from multiple users
4. Network interruption during sync
5. Server restart with active connections

## Performance Considerations

### Optimizations
- Implement document lazy loading
- Use Automerge binary format for efficiency
- Batch WebSocket messages
- Implement presence indicators efficiently

### Monitoring
- Track sync latency
- Monitor WebSocket connection health
- Log Automerge document size growth
- Track active connections per document

## Security Considerations

### Authentication
- Extend current auth to WebSocket connections
- Validate document access permissions
- Rate limit sync messages

### Data Validation
- Validate Automerge binary data
- Sanitize all WebSocket messages
- Implement max document size limits

## Migration Strategy

### Rollout Plan
1. Deploy backend with WebSocket support (backward compatible)
2. Add Automerge columns to database
3. Implement document migration utility
4. Deploy frontend with opt-in collaboration
5. Gradually enable for all documents

### Rollback Plan
- Keep markdown content in sync with Automerge
- Allow disabling collaborative features
- Export to plain markdown functionality

## Future Enhancements

1. **Presence Awareness**: Show cursor positions and selections
2. **Comments**: Add inline comments using Automerge
3. **Version History**: Browse and restore document versions
4. **Conflict Visualization**: Show merge conflicts visually
5. **Permission System**: Read-only viewers, edit permissions
6. **Performance**: Implement Automerge compaction strategies

## Dependencies Summary

### Backend
- @automerge/automerge
- @automerge/automerge-repo
- ws (WebSocket server)

### Frontend
- @automerge/automerge
- @automerge/automerge-codemirror
- @automerge/automerge-repo-network-websocket

## Success Metrics

- Sub-100ms sync latency for typical edits
- Support for 10+ concurrent editors
- Zero data loss during conflicts
- Seamless offline/online transitions
- Backward compatibility maintained

## Timeline Estimate

- Phase 1 (Backend): 3-4 days
- Phase 2 (Frontend): 2-3 days
- Phase 3 (Testing & Polish): 2-3 days
- Total: ~1.5-2 weeks for MVP

This plan provides a comprehensive approach to integrating Automerge with the existing TnyOffice Docs application while maintaining stability and providing a clear upgrade path.
```

Result:

```
File created successfully at: /Users/jakelevirne/dev/specstoryai/tnyOffice/apps/docs/plans/automerge_plan.md
```

_**Agent (claude-opus-4-20250514)**_

**Agent task list:**
- [X] ðŸ”¥ Read automerge-codemirror source files to understand implementation
- [X] ðŸ”¥ Create automerge_plan.md with integration design


_**Agent (claude-opus-4-20250514)**_

Created automerge_plan.md in apps/docs/plans/ with a comprehensive integration plan for using @automerge/automerge-codemirror with your API.

